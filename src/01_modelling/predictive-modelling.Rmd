---
title: "Predictive-modelling per accident class"
author:
  - name: "Alejandro Cadavid Romero"
    email: alcadavidro@unal.edu.co
    affiliation: Universidad Nacional de Colombia
  - name: "Santiago Vasquez Rodriguez"
    email: svasquezro@unal.edu.co
    affiliation: Universidad Nacional de Colombia
date: "8/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

Este documento hace parte del trabajo del curso de **Analítica Predictiva** de la Universidad Nacional de Colombia para la Maestría en Ingeniería y Especialización en Analítica. El alcance de este es la creación de modelos predictivos para la estimación de cantidad de accidentes en el valle del aburra a nivel mensual, semanal y diario.  

### Carga de librerias
```{r loading-libraries}
# Manipulación de datos
library(dplyr)
library(tidyr)
library(lubridate)
library(PerformanceAnalytics)
library(xts)
library(Metrics)
library(glmnet)

# Visualización
library(ggplot2)

# Formato tablas
library(kableExtra)
```


### Carga de datos  
```{r loading-data}
df_train <- read.csv('../../data/processed/train_data.csv')
df_test <- read.csv('../../data/processed/test_data.csv')
special_dates <- read.csv('../../data/processed/special_dates.csv')
```

```{r data-train-viz}
kable(head(df_train)) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  scroll_box(width = "100%")
```

# Modelo mensual
### Preprocesamiento de la información

```{r modelamiento-mensual}
accidentes_por_clase <- df_train %>% 
  group_by(PERIODO, MES, CLASE) %>% 
  summarise(n_accidentes=n(), .groups="drop") %>% 
  spread(CLASE, n_accidentes) %>%
  mutate(PERIODO_LEAD=lead(PERIODO), MES_LEAD=lead(MES), rank = 1:length(PERIODO)) %>%
  filter(rank < max(rank)) %>%
  dplyr::select(-c(PERIODO, MES, rank)) 

accidentes_por_gravedad <- df_train %>% 
  group_by(PERIODO, MES, GRAVEDAD) %>%
  summarise(n_accidentes=n(), .groups="drop") %>% 
  spread(GRAVEDAD, n_accidentes) %>%
  mutate(PERIODO_LEAD=lead(PERIODO), MES_LEAD=lead(MES), rank = 1:length(PERIODO)) %>%
  filter(rank < max(rank)) %>%
  dplyr::select(-c(PERIODO, MES, rank)) 


time_series <- df_train %>% 
  filter(CLASE == "choque") %>% 
  group_by(PERIODO, MES) %>%
  summarise(n_accidentes=n(), .groups="drop") %>%
  mutate(
    FECHA=as.Date(paste(PERIODO, formatC(MES, width = 2, flag = "0"), "01", sep='-')),
    t_minus_1=lag(n_accidentes, n = 1),
    t_minus_2=lag(n_accidentes, n = 2),
    t_minus_3=lag(n_accidentes, n = 3),
    t_minus_4=lag(n_accidentes, n = 4),
    t_minus_5=lag(n_accidentes, n = 5),
    t_minus_6=lag(n_accidentes, n = 6),
    t_minus_7=lag(n_accidentes, n = 7)
  ) %>% 
  dplyr::select(PERIODO, MES, t_minus_1, t_minus_2) 

time_series_day <- df_train %>% 
  filter(CLASE == "choque") %>% 
  group_by(PERIODO, MES, DIA) %>% 
  summarise(n_accidentes=n(), .groups="drop") %>%
  group_by(PERIODO, MES) %>% 
  summarise(avg_day_accidentes = mean(n_accidentes), .groups="drop") %>% 
  mutate(
    t_day_minus_1=lag(avg_day_accidentes, n = 1),
    t_day_minus_2=lag(avg_day_accidentes, n = 2),
    t_day_minus_3=lag(avg_day_accidentes, n = 3)
  ) %>% 
  dplyr::select(PERIODO, MES, t_day_minus_1)  

# estadisticas_barrios <- df_train %>%
#   filter(CLASE=="choque") %>% 
  

# time_series <- as.xts(time_series$n_accidentes, time_series$FECHA)
# mean_5 <- apply.rolling(time_series, width = 5, FUN = "mean")
# sd_5 <- apply.rolling(time_series, width = 5, FUN = "sd")
# 
# mean_5 <- data.frame(date=index(mean_5), coredata(mean_5))
# sd_5 <- data.frame(date=index(sd_5), coredata(sd_5))
# past_statistics <- merge(mean_5, sd_5, by="date")
# colnames(past_statistics) <- c("date", "mean_5_months", "sd_5_months")
# past_statistics <- past_statistics %>%
#   mutate(
#     date = as_date(date),
#     lag_mean = lag(mean_5_months),
#     lag_sd = lag(sd_5_months)
#     ) %>% 
#   select(date, lag_mean, lag_sd) %>% 
#   mutate(
#     PERIODO=lubridate::year(date),
#     MES=lubridate::month(date)
#     )

```

```{r modelamiento-mensual}
df_train_transformed <- df_train %>%
  filter(CLASE == "choque") %>%
  group_by(PERIODO, MES) %>% 
  summarise(
    numero_accidentes = n(),
    .groups="drop"
  ) %>% 
  mutate(
    NUMERO_DIAS=days_in_month(as.Date(paste(PERIODO, formatC(MES, width = 2, flag = "0"), "01", sep='-'))), 
    MES=factor(MES)) %>% 
  merge(accidentes_por_clase,
        by.x = c("PERIODO", "MES"), by.y = c("PERIODO_LEAD", "MES_LEAD")) %>%
  replace_na(list(incendio=0)) %>%
  merge(accidentes_por_gravedad, by.x = c("PERIODO", "MES"), by.y = c("PERIODO_LEAD", "MES_LEAD")) %>%
  merge(time_series, by = c("PERIODO", "MES")) %>%
  arrange(PERIODO, MES, .by_group = T) %>% 
  filter(!is.na(t_minus_2)) %>% 
  mutate(incendio=incendio+1) %>%
  mutate_at(vars(-PERIODO, -MES, -NUMERO_DIAS), funs(log(.))) %>% 
  merge(special_dates, by = c("PERIODO", "MES")) %>% 
  dplyr::select(-c(PERIODO, choque))
```

```{r entrenamientos}
modelo.1 <- lm(numero_accidentes ~ ., data=df_train_transformed)
step.model <- stepAIC(modelo.1, direction = "both", trace = F, steps = 2000)
summary(step.model)
```

```{r}

x <- model.matrix(numero_accidentes ~ ., data=df_train_transformed)[, -1]
y <- df_train_transformed$numero_accidentes

lasso.model <- cv.glmnet(x=x, y=y, alpha=1, nfolds = 10, type.measure = "mse")

lasso.model.final <- glmnet(x=x, y=y, alpha=1, lambda=lasso.model$lambda.1se)
coef(lasso.model.final)
```

```{r predicciones}
data.frame(
  predicciones=exp(predict(modelo.1, df_train_transformed)),
  real = exp(df_train_transformed$numero_accidentes)
  )
```

```{r predicciones}
plot(step.model)
```

```{r Analisis por meses}
ggplot(df_train %>% 
         group_by(PERIODO, MES) %>% 
         summarise(accidentes = n(), .groups="drop") %>%
         group_by(MES) %>% 
         summarise(avg_mes = mean(accidentes), sd_mes = sd(accidentes)) ,
       aes(x=MES, y=avg_mes)) +
  geom_bar( stat = "identity") +
  geom_errorbar(aes(ymin=avg_mes-sd_mes, ymax=avg_mes+sd_mes), width=.2,
                position=position_dodge(.9)) + 
  theme_classic() + scale_x_discrete(name ="Mes", limits=factor(1:12))
```

